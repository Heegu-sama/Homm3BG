name: Build release version

on:
  workflow_dispatch:

jobs:
  matrix-setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          cat << 'EOF' > matrix.json
          {
            "include": [
              { "language_name": "English", "language": "en", "display": "ðŸ‡ºðŸ‡¸ English"},
              { "language_name": "Polski", "language": "pl", "display": "ðŸ‡µðŸ‡± Polski"},
              { "language_name": "Espanol", "language": "es", "display": "ðŸ‡ªðŸ‡¸ EspaÃ±ol"},
              { "language_name": "Francais", "language": "fr", "display": "ðŸ‡«ðŸ‡· FranÃ§ais"},
              { "language_name": "Ruuskiy", "language": "ru", "display": "ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹"},
              { "language_name": "Ukrainska", "language": "ua", "display": "ðŸ‡ºðŸ‡¦ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°"},
              { "language_name": "Deutsch", "language": "de", "display": "ðŸ‡©ðŸ‡ª Deutsch"},
              { "language_name": "Cestina", "language": "cs", "display": "ðŸ‡¨ðŸ‡¿ ÄŒeÅ¡tina"},
              { "language_name": "Ivrit", "language": "he", "display": "ðŸ‡®ðŸ‡± ×¢×‘×¨×™×ª"}
            ]
          }
          EOF
          echo "matrix=$(jq -c . matrix.json)" >> $GITHUB_OUTPUT

      - id: set-version
        run: echo "version=$(cat .version | tr . _)" >> $GITHUB_OUTPUT

  digital_build:
    needs: matrix-setup
    name: "Digital / ${{ matrix.display }}"
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-setup.outputs.matrix) }}
    uses: ./.github/workflows/pdf-build.yaml
    with:
      language: ${{ matrix.language }}
      build_type: digital
      file_name: "Heroes3_${{ matrix.language_name }}_Rules_Rewrite_${{ needs.matrix-setup.outputs.version }}"

  printable_build:
    needs: matrix-setup
    name: "Printable / ${{ matrix.display }}"
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-setup.outputs.matrix) }}
    uses: ./.github/workflows/pdf-build.yaml
    with:
      language: ${{ matrix.language }}
      build_type: printable
      file_name: "Heroes3_${{ matrix.language_name }}_Rules_Rewrite_${{ needs.matrix-setup.outputs.version }}_Printable"
      convert_to_cmyk: true

  economy_build:
    needs: matrix-setup
    name: "Printable Economy / ${{ matrix.display }}"
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-setup.outputs.matrix) }}
    uses: ./.github/workflows/pdf-build.yaml
    with:
      language: ${{ matrix.language }}
      file_name: "Heroes3_${{ matrix.language_name }}_Rules_Rewrite_${{ needs.matrix-setup.outputs.version }}_Economy_Printable"
      build_type: economy

  upload_single_package:
    runs-on: ubuntu-latest
    needs: [matrix-setup, digital_build, printable_build, economy_build]
    steps:
      - name: Create dir
        run: mkdir all_booklets

      - name: Download compiled books
        uses: actions/download-artifact@v4
        with:
          pattern: "Heroes3_*"
          path: all_booklets
          merge-multiple: true

      - name: Upload single package
        uses: actions/upload-artifact@v4
        with:
          name: "All_booklets_${{ needs.matrix-setup.outputs.version }}"
          path: all_booklets
          retention-days: 7
